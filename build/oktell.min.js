Oktell=function(){var b=!1,c="",d=function(){if(b){var a=new Date,d=a.getFullYear()+"-"+(a.getMonth()<10?"0":"")+a.getMonth()+"-"+(a.getDate()<10?"0":"")+a.getDate(),e=(a.getHours()<10?"0":"")+a.getHours()+":"+(a.getMinutes()<10?"0":"")+a.getMinutes()+":"+(a.getSeconds()<10?"0":"")+a.getSeconds()+":"+(a.getMilliseconds()+1e3).toString().substr(1);c+=d+" "+e+" | ",args=["Oktell.js "+e+" |"];for(var f=0,g=arguments.length;g>f;f++)c+=("object"==typeof arguments[f]?JSON.stringify(arguments[f]):arguments[f])+" | ",args.push(arguments[f]);c+="\n\n";try{console.log.apply(console,args||[])}catch(h){b=!1}}},e=function(a){var b,c,d,e,f,g,h,i,j,k,l=function(a,b){return a<<b|a>>>32-b},m=function(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f},n=function(a,b,c){return a&b|~a&c},o=function(a,b,c){return a&c|b&~c},p=function(a,b,c){return a^b^c},q=function(a,b,c){return b^(a|~c)},r=function(a,b,c,d,e,f,g){return a=m(a,m(m(n(b,c,d),e),g)),m(l(a,f),b)},s=function(a,b,c,d,e,f,g){return a=m(a,m(m(o(b,c,d),e),g)),m(l(a,f),b)},t=function(a,b,c,d,e,f,g){return a=m(a,m(m(p(b,c,d),e),g)),m(l(a,f),b)},u=function(a,b,c,d,e,f,g){return a=m(a,m(m(q(b,c,d),e),g)),m(l(a,f),b)},v=function(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=new Array(f-1),h=0,i=0;c>i;)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g},w=function(a){var b,c,d="",e="";for(c=0;3>=c;c++)b=a>>>8*c&255,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d},x=[],y=7,z=12,A=17,B=22,C=5,D=9,E=14,F=20,G=4,H=11,I=16,J=23,K=6,L=10,M=15,N=21;for(x=v(a),h=1732584193,i=4023233417,j=2562383102,k=271733878,b=x.length,c=0;b>c;c+=16)d=h,e=i,f=j,g=k,h=r(h,i,j,k,x[c+0],y,3614090360),k=r(k,h,i,j,x[c+1],z,3905402710),j=r(j,k,h,i,x[c+2],A,606105819),i=r(i,j,k,h,x[c+3],B,3250441966),h=r(h,i,j,k,x[c+4],y,4118548399),k=r(k,h,i,j,x[c+5],z,1200080426),j=r(j,k,h,i,x[c+6],A,2821735955),i=r(i,j,k,h,x[c+7],B,4249261313),h=r(h,i,j,k,x[c+8],y,1770035416),k=r(k,h,i,j,x[c+9],z,2336552879),j=r(j,k,h,i,x[c+10],A,4294925233),i=r(i,j,k,h,x[c+11],B,2304563134),h=r(h,i,j,k,x[c+12],y,1804603682),k=r(k,h,i,j,x[c+13],z,4254626195),j=r(j,k,h,i,x[c+14],A,2792965006),i=r(i,j,k,h,x[c+15],B,1236535329),h=s(h,i,j,k,x[c+1],C,4129170786),k=s(k,h,i,j,x[c+6],D,3225465664),j=s(j,k,h,i,x[c+11],E,643717713),i=s(i,j,k,h,x[c+0],F,3921069994),h=s(h,i,j,k,x[c+5],C,3593408605),k=s(k,h,i,j,x[c+10],D,38016083),j=s(j,k,h,i,x[c+15],E,3634488961),i=s(i,j,k,h,x[c+4],F,3889429448),h=s(h,i,j,k,x[c+9],C,568446438),k=s(k,h,i,j,x[c+14],D,3275163606),j=s(j,k,h,i,x[c+3],E,4107603335),i=s(i,j,k,h,x[c+8],F,1163531501),h=s(h,i,j,k,x[c+13],C,2850285829),k=s(k,h,i,j,x[c+2],D,4243563512),j=s(j,k,h,i,x[c+7],E,1735328473),i=s(i,j,k,h,x[c+12],F,2368359562),h=t(h,i,j,k,x[c+5],G,4294588738),k=t(k,h,i,j,x[c+8],H,2272392833),j=t(j,k,h,i,x[c+11],I,1839030562),i=t(i,j,k,h,x[c+14],J,4259657740),h=t(h,i,j,k,x[c+1],G,2763975236),k=t(k,h,i,j,x[c+4],H,1272893353),j=t(j,k,h,i,x[c+7],I,4139469664),i=t(i,j,k,h,x[c+10],J,3200236656),h=t(h,i,j,k,x[c+13],G,681279174),k=t(k,h,i,j,x[c+0],H,3936430074),j=t(j,k,h,i,x[c+3],I,3572445317),i=t(i,j,k,h,x[c+6],J,76029189),h=t(h,i,j,k,x[c+9],G,3654602809),k=t(k,h,i,j,x[c+12],H,3873151461),j=t(j,k,h,i,x[c+15],I,530742520),i=t(i,j,k,h,x[c+2],J,3299628645),h=u(h,i,j,k,x[c+0],K,4096336452),k=u(k,h,i,j,x[c+7],L,1126891415),j=u(j,k,h,i,x[c+14],M,2878612391),i=u(i,j,k,h,x[c+5],N,4237533241),h=u(h,i,j,k,x[c+12],K,1700485571),k=u(k,h,i,j,x[c+3],L,2399980690),j=u(j,k,h,i,x[c+10],M,4293915773),i=u(i,j,k,h,x[c+1],N,2240044497),h=u(h,i,j,k,x[c+8],K,1873313359),k=u(k,h,i,j,x[c+15],L,4264355552),j=u(j,k,h,i,x[c+6],M,2734768916),i=u(i,j,k,h,x[c+13],N,1309151649),h=u(h,i,j,k,x[c+4],K,4149444226),k=u(k,h,i,j,x[c+11],L,3174756917),j=u(j,k,h,i,x[c+2],M,718787259),i=u(i,j,k,h,x[c+9],N,3951481745),h=m(h,d),i=m(i,e),j=m(j,f),k=m(k,g);var O=w(h)+w(i)+w(j)+w(k);return O.toLowerCase()},f=function(a){var b=[],c=0,d=0,e=0,f=0,g=0;for(a+="";c<a.length;)e=a.charCodeAt(c),128>e?(b[d++]=String.fromCharCode(e),c++):e>191&&224>e?(f=a.charCodeAt(c+1),b[d++]=String.fromCharCode((31&e)<<6|63&f),c+=2):(f=a.charCodeAt(c+1),g=a.charCodeAt(c+2),b[d++]=String.fromCharCode((15&e)<<12|(63&f)<<6|63&g),c+=3);return b.join("")},g=function(a){for(var b="",c=0,d=0;d<a.length;d++)c=a.charCodeAt(d),c>127?c>1024&&(1025==c?c=1016:1105==c&&(c=1032),b+=String.fromCharCode(c-848)):b+=a.charAt(d);return b},h=function(a){var b,c,d,e,g,h,i,j,k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,m=0,n="",o=[];if(!a)return a;a+="";do e=k.indexOf(a.charAt(l++)),g=k.indexOf(a.charAt(l++)),h=k.indexOf(a.charAt(l++)),i=k.indexOf(a.charAt(l++)),j=e<<18|g<<12|h<<6|i,b=j>>16&255,c=j>>8&255,d=255&j,o[m++]=64==h?String.fromCharCode(b):64==i?String.fromCharCode(b,c):String.fromCharCode(b,c,d);while(l<a.length);return n=o.join(""),n=f(n)},i=function(a){var b=Array.prototype.slice.call(arguments,1);return n(b,function(b){n(b,function(c,d){b.hasOwnProperty(d)&&(a[d]=c)})}),a},j=function(a){return Array.isArray?Array.isArray(a):"[object Array]"==Object.prototype.toString.call(a)},k=function(a,b){if(b)return JSON.parse(JSON.stringify(a));var c={};for(var d in a)a.hasOwnProperty(d)&&(c[d]="object"==typeof a[d]?k(a[d],!1):a[d]);return c},l=function(a){if(a=a||[],j(a))return a.length;if(a===Object(a)){if(Object.keys)return Object.keys(a).length;var b=0;for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b++;return b}return!1},m={},n=function(a,b,c){if(null!=a)if(Array.prototype.forEach&&a.forEach===Array.prototype.forEach)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(d in a&&b.call(c,a[d],d,a)===m)return}else for(var f in a)if(Object.prototype.hasOwnProperty.call(a,f)&&b.call(c,a[f],f,a)===m)return},o=function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},p=function(a){if(!a)return"";a=a.toString().split(";").join(",");for(var b=a.split(","),c=0;c<b.length;c++){b[c]=o(b[c]);var d,e="",f="",g="";if(""!=b[c]){if(-1!=b[c].indexOf("(")){var h=b[c].split("(");e=o(h[0]),h=h[1].split(")"),f=o(h[0]);var d=o(h[1]);d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),-1==d.indexOf("-")&&(h=[d.split(" ")[0],d.split(" ").slice(1).join(" ")],d=o(h[0]),g=o(h[1]),5==d.length&&(d=d.substr(0,3)+"-"+d.substr(3,2)),6==d.length&&(d=d.substr(0,2)+"-"+d.substr(2,2)+"-"+d.substr(4,2)),7==d.length&&(d=d.substr(0,3)+"-"+d.substr(3,2)+"-"+d.substr(5,2)),""!=g&&(d+=" "+g))}else{d=b[c].split("+").join(""),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2");var h=[d.split(" ")[0],d.split(" ").slice(1).join(" ")];d=o(h[0]),d=d.split("-").join(""),d=d.split("—").join(""),g=o(h[1]),5==d.length?d=d.substr(0,3)+"-"+d.substr(3,2):6==d.length?d=d.substr(0,2)+"-"+d.substr(2,2)+"-"+d.substr(4,2):7==d.length?d=d.substr(0,3)+"-"+d.substr(3,2)+"-"+d.substr(5,2):9==d.length?(f=d.substr(0,3),d=d.substr(3,2)+"-"+d.substr(5,2)+"-"+d.substr(7,2)):10==d.length?(f=d.substr(0,3),d=d.substr(3,3)+"-"+d.substr(6,2)+"-"+d.substr(8,2)):11==d.length?(e=d.substr(0,1),f=d.substr(1,3),d=d.substr(4,3)+"-"+d.substr(7,2)+"-"+d.substr(9,2)):12==d.length?(e=d.substr(0,2),f=d.substr(2,3),d=d.substr(5,3)+"-"+d.substr(8,2)+"-"+d.substr(10,2)):13==d.length?(e=d.substr(0,3),f=d.substr(3,3),d=d.substr(6,3)+"-"+d.substr(9,2)+"-"+d.substr(11,2)):14==d.length&&(e=d.substr(0,4),f=d.substr(4,3),d=d.substr(7,3)+"-"+d.substr(10,2)+"-"+d.substr(12,2)),""!=g&&(d+=" "+g)}"8"==e&&(e="+7"),"+"!=e[0]&&""!=e&&(e="+"+e);var i=[];""!=e&&i.push(e),""!=f&&i.push("("+f+")"),""!=d&&i.push(d),b[c]=i.join(" ")}}return a=b.join(", ")},q=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},r=function(a){if("object"==typeof a){var b="";return n(a,function(a,c){b+="&"+c+"="+a.toString()}),b}return!1},s=function(a){return"string"==typeof a&&a.match(/[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}/)||32==a.length&&a.match(/[a-zA-Z0-9]{32}/)?!0:!1},t=function(a){"function"==typeof a&&a.apply(void 0,Array.prototype.slice.call(arguments,1))},u=function(a,b,c){if(arguments.length>1&&"[object Object]"!==String(b)){if(c=i({},c),(null===b||void 0===b)&&(c.expires=-1),"number"==typeof c.expires){var d=c.expires,e=c.expires=new Date;e.setSeconds(e.getSeconds()+d)}return b=String(b),document.cookie=[encodeURIComponent(a),"=",c.raw?b:encodeURIComponent(b),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}c=b||{};var f,g=c.raw?function(a){return a}:decodeURIComponent;return(f=new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)").exec(document.cookie))?g(f[1]):null},v=/\s+/,w=function(a){if("string"==typeof a)a=a.replace(/,/g," ").split(v);else{if(!(j(a)&&a.length>0))return!1;for(var b=[],c=0;c<a.length;c++){var d=a[c];d&&"string"==typeof d&&b.push(d)}eventsNames=b}return a},x={on:function(a,b,c){if(a=w(a),!a||"function"!=typeof b)return!1;var d=this._callbacks||(this._callbacks={});return n(a,function(a){if("string"!=typeof a)return m;var e=d[a]||(d[a]=[]);e.push({callback:b,context:c})}),!0},off:function(a,b){var c=this._callbacks||(this._callbacks={});if(a){if(a=w(a),!a)return!1;"function"==typeof b?n(a,function(a){"string"==typeof a&&n(c[a],function(d,e){d&&d.callback===b&&delete c[a][e]})}):n(a,function(a){delete c[a]})}else c={};return!0},trigger:function(a){a=w(a);var b=this._callbacks||(this._callbacks={});if(!a)return!1;var c=Array.prototype.slice.call(arguments,1),d=b.all;return n(a,function(a){var e=b[a];if(e&&n(e,function(a){a&&"function"==typeof a.callback&&a.callback.apply(a.context||void 0,c)}),d){var f=[a].concat(c);n(d,function(a){a&&"function"==typeof a.callback&&a.callback.apply(a.context||void 0,f)})}}),!0}},y=function(a,b,c,e,f){var g,k={},l=/^ws[s]{0,1}:\/\/\S+$/i,o=this,p=!1,q=!1,r={},s={},u={},v={},x={dynamic:["executemethod","cancelmethod"],dynamicwaitabort:["executemethodwaitaborted"],chat:["chatmessageviewed","chatmessage","chatmemberremoved","chatmemberadded","chatnamechanged","chatcreated"],dlgcard:["dlgcard_showreserve","dlgcard_showconfirm","dlgcard_showformstop","dlgcard_showformdialog","dlgcard_closeall","dlgcard_closereserve","dlgcard_closeformreturnvalues","dlgcard_closeformreturncomment"]};o.setQueryDelayMin(c),o.setQueryDelayMax(e);var y=function(a){if(!j(a))return!1;for(var b,c="https:"==location.protocol?!0:!1,d=80,e=[],f=a.length;f>b;b++){if("string"!=typeof a[b])return!1;if(l.text(a[b]))e.push(a[b]);else{var g=a[b].split(":"),h=g[0],i=g[1];i||(i=d,e.push(h+":4066")),"443"==i&&(c=!0),e.push(h+":"+i)}}for(var b,k=c?"wss://":"ws//",f=e.length;f>b;b++)l.text(a[b])||(e[b]=k+e[b])},z=function(){},A=function(){},B=!1,C=function(a){if(B)a.close();else{B=!0,g=a;var b=Math.random().toString();g.onmessage=function(c){var d=JSON.parse(c.data),e=function(a){o.ws=a,a.onmessage=F,a.onclose=z,a.onerror=A,E()};if("websocketredirect"==d[0]){var f=new WebSocket(a.url.replace("ws://","wss://").replace(":4066",":443"),"json");f.onopen=function(){e(f)}}else d[1]&&d[1].qid==b&&e(a)},g.send(JSON.stringify(["ping",{qid:b}]))}};o.n_connect=function(){for(var b,c=y(a),d=c.length;d>b;b++)setTimeout(function(){var a=new WebSocket(c[b],"json");a.onopen=function(){C(a)},a.onerror=function(){},a.onclose=function(){}},1)},o.url=a;var D=function(){q||(q=!0,o.trigger("errorConnection"))},E=function(){p=!0,"function"==typeof f&&(d("success connect to "+g.url),f(g.url))},F=function(a){var b=JSON.parse(a.data);H(b);var c=!1;if("multipart"==b[0]){var d=s[b[1]["message-id"]];if(d||(d={packetcount:b[1].packetcount,content:[],value:""},s[b[1]["message-id"]]=d),d.content[parseInt(b[1].packetnumber)]=b[1].content.toString(),d.content.length==d.packetcount){for(var e=0;e<d.content.length;e++)d.value=""+d.value+h(d.content[e]);c=!0}}if(("multipart"!=b[0]||"multipart"==b[0]&&c)&&(c&&(b=JSON.parse(s[b[1]["message-id"]].value)),"function"==typeof r[b[1].qid])){var f=r[b[1].qid];delete r[b[1].qid];var g=b[1];void 0===g.result&&(g.result=1),f(b[1])}},G=function(){p?q||o.trigger("connectionClose"):D(),v={}};o.multiConnect=function(){j(a)||(a=[a]),d("Multi connect start",a);var c=0;a=a.slice(0,10),n(a,function(e){setTimeout(function(){try{k[e]=new WebSocket(e,"json"),d("trying to connect "+e),k[e].onopen=function(){k[e].wasOpened=!0;var a=Math.random().toString();k[e].send(JSON.stringify(["ping",{qid:a}])),k[e].onmessage=function(b){if(p)return!1;var c=JSON.parse(b.data),f=function(){o.url=e,o.wsUrl=g=k[e],g.onmessage=F,g.onclose=G,E()};if("websocketredirect"==c[0]){var h=e.replace(/^ws:\/\//,"wss://").replace(/:[0-9]{1,5}/,":443");d("redirect to secure websocket, trying to connect "+h),k[e].close(),e=h;var i=new WebSocket(e,"json");i.onopen=function(){return p?!1:void f()},k[e]=i}else c[1]&&c[1].qid==a&&f()}},setTimeout(function(){(1!=o.getWebSocketState(k[e])&&!k[e].wasOpened||o.url!=e)&&(o.disconnect(k[e]),c++,c==a.length&&(c=-999,D()))},b)}catch(f){return c++,c==a.length&&(c=-999,o.trigger("errorConnection",f)),m}},1)})},o.connect=function(){q=!1;try{d("trying to connect "+a),g=new WebSocket("ws://"+a,"json"),setTimeout(function(){0==o.getWebSocketState()&&(o.disconnect(),D())},b)}catch(c){return o.trigger("errorConnection",c),!1}g.onopen=E,g.onmessage=F,g.onclose=G},o.send=function(a,b,c){JSON.parse(a);if("function"==typeof c&&(r[b]=c),o.delayMin>0){var d=o.delayMin;return e&&(d=Math.round(Math.random()*Math.abs(o.delayMax-o.delayMin)+o.delayMin)),setTimeout(function(){g.send(a)},d),!0}return g.send(a)},o.sendOktell=function(a,b,c){b=b||{};var d=new Array;d.push(a),b.qid=Math.random().toString(),d.push(b),o.send(JSON.stringify(d),d[1].qid,c)===!1&&t(c,{result:0,errormsg:"websocket send error"})},o.execProc=function(a,b,c){var d=["execpredefineddbstoredproc",i({qid:Math.random().toString(),procedure:a},b)];o.send(JSON.stringify(d),d[1].qid,function(a){var b=[];if(1==a.result&&0==a.errorcode)for(var d=0;d<a.dataset.length;d++){var e=[];b.push(e);for(var f=[],g=0;g<a.dataset[d][0].length;g++)f.push(a.dataset[d][0][g]);for(var h=1;h<a.dataset[d].length;h++){for(var i={},j=0;j<f.length;j++)i[f[j]]=a.dataset[d][h][j];e.push(i)}}else b=!1;t(c,b,a.dataset)})},o.bindOktellEvent=function(a,b){return a=w(a),a&&"function"==typeof b?(n(a,function(a){u[a]||(u[a]=[]),u[a].push(b)}),o.sendOktellEventSubscription(a),!0):!1};var H=function(a){u&&u[a[0]]&&(d("<<< EVENT "+a[0],a[1]),n(u[a[0]],function(b){t(b,a[1])}))};o.sendOktellEventSubscription=function(a,b){var c=this;if(a=w(a),!a)return!1;var e=[];n(a,function(a){v[a]||(e.push(a),j(x[a])&&c.sendOktellEventSubscription(x[a],!0)),b&&(v[a]=!0)}),!b&&e.length&&(d("===> Event subscription",e),c.sendOktell("subscribeevent",{eventmethod:e},function(a){d("<=== Event subscribtion result: "+a.result,e),n(e,function(a){v[a]=!0})}))},o.unbindOktellEvent=function(a,b){if(a){if(a=w(a),!a)return!1;b="function"==typeof b?b:!1;for(var c=0;c<a.length;c++){var d=a[c];b?n(u[d],function(a,c){a===b&&delete u[d][c]}):delete u[d]}}else u={};return!0},o.reSendOktellEventSubscribtions=function(){var a=[];n(v,function(b,c){b&&a.push(c)}),a.length&&o.sendOktell("subscribeevent",{eventmethod:a},function(){})},o.disconnect=function(a){a=a||g,a.close();var b=o.getWebSocketState(a);return 3==b||2==b?!0:!1},o.getWebSocketState=function(a){return a=a||g,a?a.readyState:void 0}};y.prototype.setQueryDelayMin=function(a){a=parseInt(a),a&&(this.delayMin=a)},y.prototype.setQueryDelayMax=function(a){a=parseInt(a),a&&(this.delayMax=a)},i(y.prototype,x);var z=function(){},A=function(){var f,h,o,v,A,B=this,C=!1,D=[],E={openTimeout:1e4,queryTimeout:2e4,queueInterval:5e3,oktellVoice:!1},F=!1,G={redirectNumber:void 0,allowedProcedures:{}},H={getmyuserinfo:{v:120327,critical:!0},getversion:{v:120112,critical:!0},pbxmakeflash:{v:120725},getextendedlineinfo:{v:120112,critical:!0},getflashedabonentinfo:{v:120112,critical:!0},saveredirectrules:{v:120725},deleteredirectrules:{v:120725},getredirectrules:{v:120725},pbxmaketransfer:{v:120725},triggercustomevent:{v:120725},getallusernumbers:{v:120920},cc_getlunchtypes:{v:130101},pbxanswercall:{v:131218}},I={},J="___oktellsessionid",K={},L={},M={},N=!1,O=function(a,b,c){B[a]||"function"!=typeof b||(B[a]=function(){return b.apply(c||B,arguments)})},P=function(a){return void 0!==a&&(C=a?!0:!1),C},Q=i({},x),R=function(){return f&&1==f.getWebSocketState()?!0:!1},S=function(a,b){if(void 0===a||!l(b))return!1;a=parseInt(a);var c="";return n(b,function(b,d){b==a&&(c=d.toLowerCase())}),c},T=function(a){if(!a||"string"!=typeof a&&"number"!=typeof a&&!j(a))return!1;("string"==typeof a||"number"==typeof a)&&(a=[a.toString()]);var b=!0;return n(a,function(a){return"string"!=typeof a?(b=!1,m):void 0}),b?a:!1},U=function(a){return G.oktellDated&&H[a]&&G.oktellDated<H[a].v?!1:!0},V={10:"critical ws method not supported by this version of Oktell server",11:"error loading version info",12:"websocket connection closed",13:"disconnected by user",14:"can't login using oktell.connect"},W=function(a,b){return{code:a,message:V[a]+" "+(b||"")||""}},X={1e3:"something goes wrong",1101:"method not supported by current Oktell version",1102:"server didnt understand method or response timeout",1103:"error execute method",1104:"bad method for execute",1105:"error execute stored procedure",1106:"bad params",1200:"cant connect to server",1201:"error websocket connection",1202:"error loginpass",1203:"oktell version too old",1204:"using oktell desktop client",1205:"error url",1206:"error loading version info",1207:"error loading phone state",1209:"error loading user state",1210:"error loading user info",1211:"login failure",1212:"error connect using session",1213:"no password or session",1214:"max online users count reached, license limitation",1215:"oktell service is not available",2001:"user state - disconnected",2002:"phone not connected",2101:"user has hold call and is talking now",2102:"user in conference now",2103:"phone state not valid for call",2104:"user state - busy",2105:"calling number is talking with us",2106:"bad number",2107:"error autocall method call",2108:"error user or phone state for call",2201:"no numbers to invite",2202:"cant build conference from current call",2203:"no number to create conference",2204:"error conference method call",2205:"bad user or phone state for creating conference",2206:"cant invite hold abonent",2207:"error inviting",2208:"cant create conference while in callcenter in break",2301:"error transfer method call",2302:"bad user or phone state for transfer",2303:"nothing to transfer",2304:"bad number for transfer",2401:"error toggle method executing",2402:"nothing to toggle, no hold",2501:"not in conference",2502:"server retunred error while enabling ghost mode",2503:"bad ghost mode",2504:"bad userId or number",2505:"error rigths",2506:"user is not in ghost mode",2507:"cant change ghost mode of this user",2601:"bad flash mode",2602:"error while exec flash method",2701:"error while loading user queue",2801:"wrong old password",2802:"incorrect new password",2803:"error while exec changepassword method on server",2901:"incorrect state",2902:"phone probably does not support intercom calls",3001:"error while getting temp pass",3002:"aborted in beforeRequest callback function"},Y=function(a,b,c){a=parseInt(a);var e=i(c||{},{result:!1,errorCode:a,errorMessage:(X[a]?X[a]:"")+(b?b.toString():"")});return d("ERROR "+a+" "+e.errorMessage,e),e},Z=function(a){var b=i(a||{},{result:!0});return d("SUCCESS ",b),b},$=function(a,b,c,d){return a?Z(b):Y(c,d,b)},_=function(a,b){a=w(a),evObjs=[];for(var c=0;c<a.length;c++){for(var d=a[c],e=!1,g=0;g<D.length;g++){var h=D[g];if(h&&h.eventName==d&&h.callback===b){e=!0;break}}if(e)a[c]=void 0;else{var i={eventName:d,callback:b};D.push(i),evObjs.push(i)}}if(P()){for(var c=0;c<evObjs.length;c++)evObjs[c].binded=!0;f.bindOktellEvent(a,b)}},aa=function(a,b){if(a){if(a=w(a),!a)return!1;b="function"==typeof b?b:!1;for(var c=0;c<a.length;c++)for(var d=a[c],e=0;e<D.length;e++){var g=D[e];g&&g.eventName==d&&(b&&g.callback===b||!b)&&(D[e]=void 0)}}else D=[];f&&f.unbindOktellEvent(a,b)},ba=function(a,b,c){var e="function"==typeof b?b:c;if(R())if(U(a)){b=l(b)?b:{};var g,b=i({userlogin:G.login},b);if("function"==typeof e)var g=setTimeout(function(){d("error timer for method "+a),t(e,Y(1102,": "+a))},E.queryTimeout);f.sendOktell(a,b,function(b){clearTimeout(g),d("<<<< "+a,b),t(e,b)}),d(">>>> "+a,b)}else t(e,Y(1101," "+a)),H[a].critical&&xa(W(10),a);else t(e,Y(1201))},ca=function(a,b,c){var e="function"==typeof b?b:c;if(a)if(G.allowedProcedures[a.toLowerCase()]){var g={userid:G.userid,userlogin:G.login,inputparams:b||{}};d(">>>> "+a,g),f.execProc(a,g,function(b,c){var f={result:!1};b&&(f.result=!0,f.datasets=b,f.datasetsRaw=c),d("<<<< "+a,f),t(e,$(f.result,f,1105," "+a))})}else e?ba(a,b,function(b){var c=b.errorCode?$(b.result,b,b.errorCode):$(b.result,b,1103," "+a);t(e,c)}):ba(a,b);else t(e,Y(1104))};O("exec",ca);var da=i({sendCustomBinding:function(){if(this._subscribed)return!1;this._subscribed=!0;var a=this;f.bindOktellEvent("customevent",function(b){b&&b.eventname&&a.trigger(b.eventname,b.eventparam)})},triggerCustomEvent:function(a,b,c,d){ba("triggercustomevent",{userid:G.userid,userlogin:G.login,eventname:a,eventparam:c,recipients:b,sendback:d?1:"0"})}},x);O("triggerCustomEvent",da.triggerCustomEvent,da),O("offCustomEvent",da.off,da),O("onCustomEvent",da.on,da);var ea=function(a,b,c){a&&(a.avatarLink=c.link?b+c.link32x32:E.defaultAvatar||"",a.avatarLink32x32=c.link32x32?b+c.link32x32:E.defaultAvatar32x32||"",a.avatarLink96x96=c.link96x96?b+c.link96x96:E.defaultAvatar64x64||"")},fa=function(a){ba("getallusernumbers",{fillsubordinates:!0},function(b){b.result&&b.users?(n(b.users,function(a){K[a.id]={id:a.id,name:a.name,number:a.main||void 0,numbers:a.nums||[],controlledByMe:a.sub?!0:!1},K[a.id].numberObj=L[K[a.id].number]||void 0,K[a.id].numberObj&&(K[a.id].numberObj.userid=a.id,K[a.id].numberObj.userObj=K[a.id])}),ba("getalluserphotolink",{mode:"page"},function(b){if(b.result){var c=ia();n(b.links,function(a){ea(K[a.id],c,a),a.id==G.userid&&ea(G,c,a)})}t(a)})):t(a)})},ga=function(a){return a?(a=a.toString())&&K[a]&&K[a].id?K[a].controlledByMe:L[a]&&L[a].userObj?L[a].userObj.controlledByMe:!1:!1},ha=function(a){ba("getpbxnumbers",{mode:"full"},function(b){b.result&&b.numbers&&n(b.numbers,function(a){L[a.number]=a,M[a.id]=L[a.number]}),t(a)})},ia=function(){if(G.currentUrl&&G.oktellWebServerPort){var a=G.currentUrl.match(/^wss/)?"https://":"http://",b=G.currentUrl.match(/wss?:\/\/([^\s\/:]+)/)[1],c="";return("https://"==a&&"443"!=B.getMyInfo().oktellWebServerPort||"http://"==a&&"80"!=B.getMyInfo().oktellWebServerPort)&&(c=":"+B.getMyInfo().oktellWebServerPort),a+b+c}return!1},ja=function(a,b){a&&(I[a]={time:(new Date).getTime(),callback:b})},ka=function(a,b){ba("gettemphttppass",{responsetowebsock:a?!0:!1},function(a){a.result?t(b,Z(a)):t(b,Y(1103," gettemphttppass",a))})},la=function(a,b){if(a){var c=a.toString().split(".");c.length<2||-1==["jpg","gif","png","jpeg"].indexOf(c[c.length-1])||ba("setmyuserphoto",{filepath:a},function(a){t(b,$(a.result,{},1103," setmyuserphoto"))})}};O("setUserAvatar",la);var ma=function(a){ba("getuserphoto",{mode:"page"},function(b){if(b.result){var c=ia();G.avatarLink=b.link?c+b.link32x32:E.defaultAvatar||"",G.avatarLink32x32=b.link32x32?c+b.link32x32:E.defaultAvatar32x32||"",G.avatarLink96x96=b.link96x96?c+b.link96x96:E.defaultAvatar64x64||"",t(a,Z({avatarLink:G.avatarLink,avatarLink32x32:G.avatarLink32x32,avatarLink96x96:G.avatarLink96x96}))}else t(a,Y(1103," getuserphoto"))})};O("getUserAvatar",ma);var na=function(a,b,c){var d=window.$||window.jQuery||void 0;if(!d)return oa.apply(B,arguments);var e=a.accept;delete a.accept,e?(j(e)||(e=[e]),e='accept="'+e.join(",")+'"'):e="";var f=Math.random().toString().replace(".",""),g="_oktelljs_user_avatar_frame_"+f,h="_oktelljs_user_avatar_form_"+f,i="_oktelljs_user_profile_select_file_"+f;d("body").append('<iframe width="0" height="0" id="'+g+'" name="'+g+'"></iframe>'),d("body").append('<form enctype="multipart/form-data" target="'+g+'" id="'+h+'" action="" method="post"><input style="visibility: hidden;" type="file" '+e+' name="file" id="'+i+'" /></form>');var k=function(a){d("#"+h).remove(),d("#"+g).remove(),t(b,a)};d("#"+i).change(function(b){var e=d(b.currentTarget).val();if(e){var f=e.replace("/","\\").split("\\");return f=f[f.length-1],"function"==typeof c&&c(Z({fileName:f}))===!1?void k(Y(3002)):void ka(!0,function(b){b.result?(d("#"+h).attr("action",ia()+"/upload?temppass="+b.password+r(a)),ja(b.password,function(a){var b=/uploadfilesresult count="1"[\s\S]+?path="([\s\S]+?)"/,c=b.exec(a);return c&&c[1]?(c=c[1].replace(/\\/g,"/"),void k(Z({path:c}))):!1}),d("#"+h).submit()):k(Y(3001))})}}),d("#"+i).click()},oa=function(a,b){var c=Math.random().toString().replace(".",""),d="_oktelljs_user_avatar_frame_"+c,e="_oktelljs_user_avatar_form_"+c,f="_oktelljs_user_profile_select_file_"+c,g=a.accept;delete a.accept,g?(j(g)||(g=[g]),g='accept="'+g.join(",")+'"'):g="";var h=document.createElement("iframe");h.id=d,h.name=d,h.width=0,h.height=0,document.body.appendChild(h);var i=document.createElement("form");i.id=e,i.style.display="none",i.target=d,i.enctype="multipart/form-data",i.action="",i.method="post",document.body.appendChild(i);var k=document.createElement("input");k.style.visibility="hidden",k.type="file",k.id=f,k.name="file",k.accept=g,i.appendChild(k);var l=function(a){var c;(c=document.getElementById(d)).parentNode.removeChild(c),(c=document.getElementById(e)).parentNode.removeChild(c),t(b,a)};k.onchange=function(){var b=k.value;if(b){var c=b.replace("\\","/").split("/");return c=c[c.length-1],"function"==typeof beforeRequest&&beforeRequest(Z({fileName:c}))===!1?void l(Y(3002)):void ka(!0,function(b){b.result?(i.action=ia()+"/upload?temppass="+b.password+"&"+r(a),ja(b.password,function(a){var b=/uploadfilesresult count="1"[\s\S]+?path="([\s\S]+?)"/,c=b.exec(a);return c&&c[1]?(c=c[1].replace(/\\/g,"/"),void l(Z({path:c}))):!1}),i.submit()):l(Y(3001))})}},k.click()};O("uploadFile",na);var pa=function(){function a(a,b){var c=this;c.oktell=a,c.server=b,c.currentMethods={},c.methodTimers={},c.onExecuteMethod=function(b){return b.executionid?(c.currentMethods[b.executionid]=!0,void a.trigger("")):!1},c.onCancelMethod=function(a){return a.executionid?void delete c.currentMethods[a.executionid]:!1},c.onExecuteMethodWaitAborted=function(a){return a.executionid?(c.currentMethods[a.executionid]=!0,void(c.methodTimers[a.executionid]=setTimeout(function(){delete c.currentMethods[a.executionid]},a.waitresponsems))):!1}}return a.prototype.init=function(){var a=this;a.server.bindOktellEvent("dynamic",function(){}),a.server.bindOktellEvent("dynamicwaitabort",function(){}),a.server.bindOktellEvent("executemethod",a.onExecuteMethod,a),a.server.bindOktellEvent("cancelmethod",a.onCancelMethod,a),a.server.bindOktellEvent("executemethodwaitaborted",a.onExecuteMethodWaitAborted,a)},a.prototype.sendMethodResult=function(a,b){var c=this;return c.currentMethods[a]?(delete c.currentMethods[a],void ba("methodresult",{executionid:a,outputparameters:b||{}})):!1},a.prototype.reset=function(){var a=this;a.currentMethods={};for(var b in a.methodTimers)a.methodTimers.hasOwnProperty(b)&&clearTimeout(a.methodTimers[b]);a.server.unbindOktellEvent("executemethod",a.onExecuteMethod),a.server.unbindOktellEvent("cancelmethod",a.onCancelMethod),a.server.unbindOktellEvent("executemethodwaitaborted",a.onExecuteMethodWaitAborted)},a}();i(pa.prototype,x);var qa=(new pa,i({},x,{_stateId:0,states:{DISCONNECTED:0,READY:1,BREAK:2,OFF:3,BUSY:5,RESERVED:6,NOPHONE:7},webStates:{READY:1,DND:2,REDIRECT:3,BREAK:4},onCallCenter:0,_onRedirect:!1,_status:0,_webStateId:0,onBreak:0,breakReasons:{},loadBreakReasons:function(a){var b=this;ba("cc_getlunchtypes",{},function(c){c.result&&n(c.items,function(a){b.breakReasons[a.id.toString()]=a}),t(a,$(c.result,c,1103," cc_getlunchtypes"))})},getStateStr:function(a){return S(void 0===a?this._stateId:parseInt(a),this.states)},getWebStateStr:function(a){return S(void 0===a?this._webStateId:parseInt(a),this.webStates)},state:function(a){return a=parseInt(a),this.getStateStr(a)&&this._stateId!==a&&(d("SET USER STATE "+a+" "+this.getStateStr(a)),this._stateId=a,this.trigger("userStateChange",this._stateId)),this._stateId},changeStates:function(a,b,c){if(a=this.webStates[a.toString().toUpperCase()]||parseInt(a),!this.getWebStateStr(a))return!1;if(a==this._webStateId&&!this.setAfterBusy||!R())return!1;var d=this.state();switch(a){case 1:d==this.states.BUSY?this.setAfterBusy=this.webStates.READY:ba("setuserstate",{userstateid:1});break;case 2:d==this.states.BUSY?this.setAfterBusy=this.webStates.DND:(d==this.states.READY||d==this.states.BREAK||d==this.states.OFF)&&ba("setuserstate",{userstateid:3});break;case 3:if(!this.getRedirectNumber())return!1;this.enableUserRedirectState(!0);break;case 4:if(this.onCallCenter){var e={userstateid:2};c&&(this.breakReasons[c]?e.lunchreasonid=c:e.lunchreasonmsg=c),ba("setuserstate",e)}}return this.webState(a,b),!0},webState:function(a,b){if(void 0!==a&&this.getWebStateStr(a)&&this._webStateId!=a){d("SET WEB STATE "+this.getWebStateStr(a));var c=this.getWebStateStr(this._webStateId);this._webStateId=a,b||B.trigger("statusChange",this.getWebStateStr(this._webStateId),c)}return this._webStateId},onRedirect:function(a){return void 0!==a&&(a=a?!0:!1,this._onRedirect!==a&&(this._onRedirect=a,Q.trigger("userOnRedirectChanged",this._onRedirect))),this._onRedirect},loadState:function(a){var b=this;ba("getuserstate",{},function(c){c.result&&b.saveStatesFromServer(c),t(a,$(c.result,c,1103," getuserstate"))})},callCenterState:function(a){return void 0!==a&&(a=a?!0:!1,this.onCallCenter!==a&&(this.onCallCenter=a,B.trigger("callCenterStateChange",this.onCallCenter))),this.onCallCenter},saveStatesFromServer:function(a){this.callCenterState(a.oncallcenter),this.onBreak=a.onlunch,this.onRedirect(a.onredirect);var b=this.webState(),c=this.state();return this.state(a.userstateid),b==this.webStates.DND&&this.setAfterBusy==this.webStates.DND&&5==c&&1==a.userstateid?(this.setAfterBusy=!1,void this.changeStates(this.webStates.DND,!0)):void this.setWebStateFromUserState()},setUserStateBusy:function(){this.state(5)},getUserRedirectId:function(){return e(G.userid.toLocaleLowerCase()+G.userid.toLocaleLowerCase()).toLowerCase()},getRedirectNumber:function(){return G.redirectNumber?G.redirectNumber:void 0},setRedirectNumber:function(a){return G.redirectNumber=a?a:void 0,G.redirectNumber},checkUserRedirect:function(a){var b=this;ba("getredirectrules",{},function(c){if(c.result){c.redirectrules&&c.redirectrules.length>0&&n(c.redirectrules,function(a){a.id.replace(/-/g,"").toLowerCase()==b.getUserRedirectId()&&b.setRedirectNumber(a.destinationnumber)})}t(a,$(c.result,c,1103," getredirectrules"))})},saveUserRedirect:function(a,b){var c=this;return a?ba("saveredirectrules",{redirectrule:{id:c.getUserRedirectId(),caption:"Переадресация сохраненная из веб-октела. Действует постоянно.",description:"Переадресация сохраненная из веб-октела. Действует постоянно.",priority:1,userid:G.userid,isenabled:!0,allowcascade:!0,state:2,destinationnumber:a,onlyforredirectstate:!0,definesources:!1}},function(d){d.result&&c.setRedirectNumber(a),t(b,$(d.result,d,1103," saveredirectrules"))}):ba("deleteredirectrules",{ids:[this.getUserRedirectId()]},function(a){a.result&&(c.setRedirectNumber(void 0),c.webState()==c.webStates.REDIRECT&&c.changeStates(c.webStates.READY)),t(b,$(a.result,a,1103," deleteredirectrules"))}),!0},enableUserRedirectState:function(a){ba("setuserstate",{onredirect:a?!0:!1})},setWebStateFromUserState:function(){if(this.onRedirect())this.webState(this.webStates.REDIRECT);else switch(this.state()){case 1:
this.webState(this.webStates.READY);break;case 2:this.webState(this.webStates.BREAK);break;case 3:this.webState(this.webStates.DND);break;case 5:this.webState(this.onBreak&&this.onCallCenter?this.webStates.BREAK:this.webStates.READY);break;case 7:this.webState(this.webStates.READY)}}}));O("setRedirectNumber",qa.saveUserRedirect,qa),O("getStatus",qa.getWebStateStr,qa),O("setStatus",qa.changeStates,qa),O("setUserStateBusy",qa.setUserStateBusy,qa);var ra={excludeConfAbStates:["Exited","MisInviteBusy","MisInviteNotRespond","MisInviteTimeout","MisInviteStop","MisInviteAbort","MisInviteRefuse"],_conferenceInfo:{},_oktellDatedWithConfNumber:140929,_holdNumber:!1,_conferenceId:!1,abonentList:{},queueList:{},answerCheckTimeout:3e3,_talkLength:0,_talkTimer:!1,sip:!1,sipActive:!1,sipHasRTCSession:!1,_notRoutingIvrState:!1,currentSessionData:{},intercomSupport:null,states:{DISCONNECTED:-1,READY:0,BACKCALL:1,CALL:2,RING:3,BACKRING:4,TALK:5},setSipPhone:function(a){var b=this;b.sip=a,b.sip.on("connect",function(){b.sipActive=!0}),b.sip.on("disconnect",function(){b.sipHasRTCSession=!1,b.sipActive=!1}),b.sip.on("ringStart",function(a,b){B.trigger("webrtcRingStart",a,b)}),b.sip.on("RTCSessionFailed",function(){}),b.sip.on("RTCSessionStarted",function(){b.sipHasRTCSession=!0,B.trigger("")}),b.sip.on("RTCSessionEnded",function(){b.sipHasRTCSession=!1,b.loadStates()}),b.sip.on("RTCSessionFailed",function(){b.sipHasRTCSession=!1}),b.sip.on("sessionClose",function(){b.sipHasRTCSession=!1,b.loadStates()})},notRoutingIvrState:function(a){return"undefined"!=typeof a&&Boolean(a)!==this._notRoutingIvrState&&(this._notRoutingIvrState=Boolean(a)),this._notRoutingIvrState},answer:function(a){var b,c,d,e=this;e.sipActive?(e.sip.answer(),t(a,Z())):e.intercomSupport===!1?t(a,Y(2902)):e.state()==e.states.RING||e.state()==e.states.BACKRING?(ba("pbxanswercall"),d=function(){clearInterval(b),clearTimeout(checkTimer),t(a,$(e.intercomSupport,{},2902))},c=function(){return e.intercomSupport=e.state()==e.states.TALK||e.state()==e.states.CALL},b=setInterval(function(){c()&&d()},50),checkTimer=setTimeout(function(){d()},e.answerCheckTimeout)):t(a,Y(2901))},setConferenceInfo:function(a){this._conferenceInfo="object"==typeof a?a:{}},getConferenceInfo:function(){return this._conferenceInfo||{}},clearHold:function(){return this.setHold(!1),!0},setHold:function(a){var b=this.getHoldInfo();if(void 0!==a&&(a.userid&&a.userid!=this._holdNumber||a.number&&a.number!=this._holdNumber||a.conferenceid&&a.conferenceid!=this._holdNumber)){var c=this._holdAbonent;this._holdNumber=a.conferenceid?a.conferenceid:a.userid?a.userid:a.number,this._holdAbonent=a.conferenceid?{isConference:!0,conferenceId:a.conferenceid,conferenceName:a.conferencename,conferenceRoom:a.conferenceroom}:this.createAbonent(a);var d=!1;(c&&c.key!=this._holdAbonent.key||!this._holdAbonent)&&(d=!0,B.trigger("holdAbonentLeave",k(c))),c&&this._holdAbonent&&this._holdAbonent.key&&c.key&&this._holdAbonent.key==c.key||(d=!0,B.trigger("holdAbonentEnter",k(this._holdAbonent)));var e=this.getHoldInfo();return(b.hasHold!=e.hasHold||d)&&B.trigger("holdStateChange",k(e)),!0}if(a===!1){this._holdAbonent&&B.trigger("holdAbonentLeave",k(this._holdAbonent)),this._holdAbonent=void 0;var f=this._holdNumber;this._holdNumber=!1,f!==this._holdNumber&&B.trigger("holdStateChange",k(this.getHoldInfo()))}return!1},getHoldInfo:function(){var a={hasHold:this._holdNumber?!0:!1};return a.hasHold&&(this._holdAbonent&&this._holdAbonent.isConference?i(a,k(this._holdAbonent)):(a.isConference=!1,a.abonent=k(this._holdAbonent))),a},conferenceId:function(a,b){if(void 0!==a&&a!=this._conferenceId){var c=this._conferenceId;this._conferenceId=a,c&&ba("confhandleevent",{conferenceid:c,eventtype:"competitors",handle:!1}),this._conferenceId?(ba("confhandleevent",{conferenceid:this._conferenceId,eventtype:"competitors",handle:!0}),b||this.loadConferenceInfo()):this.setConferenceInfo(!1)}return this._conferenceId},isConfCreator:function(a){return void 0!==a&&(this._isConfCreator=a?!0:!1),this._isConfCreator},getStateStr:function(a){return S(void 0===a?this._stateId:parseInt(a),this.states)},apiGetStateStr:function(a){var b=void 0===a?this.state():parseInt(a);return b==this.states.BACKCALL&&(b=this.states.CALL),this.getStateStr(b)},state:function(a,b,c){if(a=parseInt(a),this.getStateStr(a)&&(c||a!=this._stateId)){var e=this.apiGetStateStr(a),f=this._stateId,g=this.apiGetStateStr(f);d("CHANGE STATE FROM "+this.getStateStr(this._stateId)+" TO "+this.getStateStr(a),this.getAbonents(!0),b),this._stateId=a,(a===this.states.READY||a===this.states.DISCONNECTED)&&(this.removeAbonents(),this.conferenceId(!1),this.isConfCreator(!1),a===this.states.DISCONNECTED&&this.clearHold()),B.trigger("stateChange",e,g);var h=this.getAbonents(!0);switch(0==h.length&&(h=b),f){case this.states.READY:B.trigger("readyStop",b);break;case this.states.RING:B.trigger("ringStop",b);break;case this.states.BACKRING:B.trigger("backRingStop",b);break;case this.states.CALL:B.trigger("callStop",b);break;case this.states.BACKCALL:B.trigger("callStop",b);break;case this.states.TALK:B.trigger("talkStop",b)}switch(this._stateId){case this.states.READY:B.trigger("readyStart",h);break;case this.states.RING:B.trigger("ringStart",h);break;case this.states.BACKRING:B.trigger("backRingStart",h);break;case this.states.CALL:B.trigger("callStart",h);break;case this.states.BACKCALL:B.trigger("callStart",h);break;case this.states.TALK:B.trigger("talkStart",h)}}return this._stateId},loadFlashInfo:function(a){var b=this;ba("getflashedabonentinfo",{},function(c){c.result&&(c.containsflashed&&c.abonent?b.setHold(c.abonent):b.clearHold()),t(a,$(c.result,c,1103," getflashedabonentinfo"))})},loadStates:function(a,b){var c=this;return b=b||{},i(c.currentSessionData,b),R()?void ba("getextendedlineinfo",{},function(b){var e=function(){t(a,$(b.result,b,1103," getextendedlineinfo"))};if(d("getextendedlineinfo result and that.currentSessionData",b,c.currentSessionData),b.result){var f=c.state(),g=(c.getHoldInfo(),c.getAbonents(!0)),h=(g&&g[0]||!1,function(){d("setStateFromResultData");{var a=(c.getHoldInfo(),c.getAbonents(!0));a&&a[0]||!1}if(c.currentSessionData.isAutoCall&&!b.abonent.isautocall&&f==c.states.READY)c.state(c.states.BACKRING,g);else if(b.abonent.isautocall)c.currentSessionData.isAutoCall=!1,c.state(c.states.BACKCALL,g);else if(b.abonent.isringing)"acm_callback"==b.abonent.direction||f==c.states.BACKRING?c.state(c.states.BACKRING,g):c.state(c.states.RING,g);else if(!c.currentSessionData.isAutoCall&&(b.abonent.iscommutated||b.abonent.iswaitinginflash||b.abonent.isconference)||"lsCommutated"==b.linestatestr&&b.abonent.isivr&&!b.abonent.iswaitingforanswer){c.startTalkTimer(parseInt(b.timertalklensec)||0);var e=c.currentSessionData.commStopped;c.currentSessionData.commStopped=!1,c.state(c.states.TALK,g,e)}else b.abonent.extline||b.abonent.number?(c.currentSessionData.isAutoCall=!1,c.state(c.states.CALL,g)):"lsDisconnected"==b.linestatestr?c.state(c.states.DISCONNECTED):"lsHookUp"===b.linestatestr&&c.sipHasRTCSession?c.state(c.getHoldInfo().hasHold?c.states.READY:c.states.TALK):f==c.states.TALK&&c.sipHasRTCSession||"lsReserved"!=b.linestatestr&&(c.currentSessionData={},c.state(c.states.READY,g))});if(c.setHold(b.isflashing&&b.flashed?b.flashed:!1),b.abonent)if(b.abonent.conferenceid)c.conferenceId(b.abonent.conferenceid,!0),c.loadConferenceInfo(function(){h(),e()});else{b.abonent.chainId=b.chainid,b.calledid&&!b.abonent.callerid&&(b.abonent.callerid=b.calledid);var i=f==c.states.TALK&&c.sipHasRTCSession||b.abonent.isivr||c.currentSessionData.isAutoCall;c.setAbonent(b.abonent,i),c.conferenceId(!1),h(),e()}else e()}else e()}):!1},loadConferenceInfo:function(a){var b=this;ba("getconferenceinfo",{conferenceid:this.conferenceId()},function(c){b.setConfAbonentList(c.competitors),b.setConferenceInfo(c.conference),t(a,$(c.result,c,1103," getconferencecompetitors"))})},createAbonent:function(a){var b=a.competitorid||a.number||a.userid||a.callerid||"00000000-0000-0000-0000-000000000000"!=a.chainId&&a.chainId;if(!b&&a.isivr&&(b=q()),b){var c=new z;return i(c,{key:b,guid:a.competitorid||a.userid,isIvr:a.isivr,ivrName:a.ivrname||void 0,isConferenceCompetitor:a.competitorid?!0:!1,conferenceId:this.conferenceId(),isConferenceCreator:a.competitorid&&a.iscreator?!0:void 0,isConferenceDirector:a.competitorid&&a.isdirector?!0:void 0,isConferenceGhost:a.competitorid&&a.isghost?!0:void 0,isConferenceGhostMajor:a.competitorid&&a.isghostmajor?!0:void 0,isConferenceHidden:a.competitorid&&a.ishidden?!0:void 0,isExternal:a.isextline?!0:!1,chainId:a.chainId,phone:a.number?a.number.toString():a.callerid?a.callerid.toString():void 0,phoneFormatted:a.number?p(a.number.toString()):void 0,name:a.simplename||a.username||a.name||a.caption||a.userlogin||a.number||a.ivrname,isUser:a.userid?!0:!1,user:{id:a.userid||void 0,name:a.username||void 0,login:a.userlogin||void 0,comment:a.comment||void 0},isClient:void 0,client:{id:void 0,name:void 0},line:{id:void 0,number:void 0}}),c}return!1},setAbonent:function(a,b){var c;l(this.abonentList)&&n(this.abonentList,function(a,b){c=b});var d=this.abonentList[c];this.abonentList={};var e=a?this.createAbonent(a):void 0;return e?(this.abonentList[e.key]=e,e.key!=c&&(B.trigger("abonentListChange",this.getAbonents()),B.trigger("abonentsChange",this.getAbonents(!0)))):d&&b?this.abonentList[c]=d:c&&(B.trigger("abonentListChange",this.getAbonents()),B.trigger("abonentsChange",this.getAbonents(!0))),this.abonentList},setConfAbonentList:function(a){var b={},c=this;a&&j(a)&&n(a,function(a){if(-1===c.excludeConfAbStates.indexOf(a.confstatestr)&&(!c.getConferenceInfo().isghost||c.getConferenceInfo().isghost&&(a.isghost||a.userid==G.userid||a.number==G.number))&&(b[a.competitorid]=!0,!c.abonentList[a.competitorid])){var d=c.createAbonent(a);c.abonentList[d.key]=d,c.conferenceId()&&c.state()==c.states.TALK&&B.trigger("conferenceAbonentEnter",c.abonentList[d.key])}});var d=c.getAbonents();return n(d,function(a,d){b[d]||c.removeAbonents(d)}),B.trigger("abonentListChange",c.getAbonents()),B.trigger("abonentsChange",c.getAbonents(!0)),!0},setConfAbonent:function(b){if(b){var c=this.createAbonent(b);c&&(-1!==this.excludeConfAbStates.indexOf(b.confstatestr)||this.getConferenceInfo().isghost&&(!this.getConferenceInfo().isghost||!b.isghost&&b.userid!=G.userid&&b.number!=G.number)?this.abonentList[c.key]&&this.removeAbonents(c):this.abonentList[c.key]||(this.abonentList[c.key]=c,this.conferenceId()&&this.state()==this.states.TALK&&(B.trigger("conferenceAbonentEnter",this.abonentList[a.key]),B.trigger("abonentListChange",this.getAbonents()),B.trigger("abonentsChange",this.getAbonents(!0)))))}},getAbonents:function(a){var b=a?[]:{};return n(this.abonentList,function(c,d){a?b.push(k(c)):b[d]=k(c)}),b},isAbonent:function(a,b){if(!a)return!1;if(b=b||this.getAbonents(),l(b)){b.key&&(b=[b]);var c=!1;return n(b,function(b){return b.guid&&b.guid==a||b.user&&b.user.id&&b.user.id==a||b.client&&b.client.id&&b.client.id==a||b.phone&&b.phone==a?(c=k(b),m):void 0}),c}return!1},removeConfAbonents:function(){var a=this;n(a.abonentList,function(b,c){a.conferenceId()&&a.state()==a.states.TALK&&b.isConferenceCompetitor&&B.trigger("conferenceAbonentLeave",b),delete a.abonentList[c]})},removeAbonents:function(a){var b=this;if(a&&b.abonentList[a])b.conferenceId()&&b.state()==b.states.TALK&&b.abonentList[a].isConferenceCompetitor&&B.trigger("conferenceAbonentLeave",b.abonentList[a]),delete b.abonentList[a],B.trigger("abonentListChange",b.getAbonents()),B.trigger("abonentsChange",b.getAbonents(!0));else{if(void 0!==a||!l(b.abonentList))return!1;n(b.abonentList,function(a,c){b.conferenceId()&&b.state()==b.states.TALK&&a.isConferenceCompetitor&&B.trigger("conferenceAbonentLeave",a),delete b.abonentList[c]}),b.abonentList={}}return B.trigger("abonentListChange",b.getAbonents()),B.trigger("abonentsChange",b.getAbonents(!0)),!0},makeCall:function(a,b,c,e){var f,g=this,h="";if(a||(f=2106),qa.state()==qa.states.DISCONNECTED&&(f=2001),g.state()==g.states.DISCONNECTED&&(f=2002),g.getHoldInfo().hasHold&&g.state()==g.states.TALK&&(f=2101),g.conferenceId()&&(f=2102),-1!=[g.states.BACKCALL,g.states.BACKRING,g.states.CALL,g.states.RING].indexOf(g.state())&&(f=2103,h=" ("+g.getStateStr()+")"),g.state()!=g.states.READY||qa.state()!=qa.states.BUSY||g.getHoldInfo().hasHold||(f=2104),f)return t(e,Y(f)),!1;if(g.isAbonent(a))return t(e,Y(2105)),!1;if(g.state()==g.states.READY&&g.sipActive&&!b){g.state()==g.states.TALK&&g.sip.hold(),g.sip.call(a);{K[a],L[a]||M[a]}t(e,Z())}else{if(g.state()!=g.states.READY&&g.state()!=g.states.TALK)return d("error call, unknown state"),t(e,Y(2108)),!1;g.acmCall(a,b,c,function(a){t(e,$(a.result,a,2107))})}},acmCall:function(a,b,c,d){if(c=-1!==["abonent","user"].indexOf(c)?c:"user",!a)return!1;var e={sequence:b?"user":c,intercom:b?!0:void 0};e.number=a.toString(),ba("pbxautocallstart",e,function(a){t(d,a)})},toggleHold:function(a){var b=this;b.getHoldInfo().hasHold?(b.makeFlash("switch"),t(a,Z())):t(a,Y(2402))},makeFlash:function(a){var b=["abort","switch","next"];ba("pbxmakeflash",{mode:-1!=b.indexOf(a)?a:void 0})},conference:function(a,b){var c=this;a=T(a),qa.state()==qa.states.BREAK?t(b,Y(2208)):c.state()==c.states.TALK?c.conferenceId()&&a?c.inviteToConf(c.conferenceId(),a,b):c.conferenceId()||c.callToConf(a?function(d){d.result?c.inviteToConf(c.conferenceId(),a,b):t(b,Y(2202))}:b):c.state()==c.states.READY&&!c.conferenceId()&&a?c.createConf(a,b):t(b,Y(2205))},callToConf:function(a){var b=this;b.buildConfFromCommCallback=a,b.buildConfFromCommTimer=setTimeout(function(){t(b.buildConfFromCommCallback,Y(2202)),b.buildConfFromCommCallback=void 0},2e3),ba("buildconferencefromcommutation")},createConf:function(a,b){var c=this,d=q(),e=Math.round(1e4*Math.random()),f=[{userlogin:G.login}];a=T(a),j(a)&&n(a,function(a){f.push(s(a)?{userid:a}:G.oktellDated>=c._oktellDatedWithConfNumber?{number:a}:{intnumber:a})}),l(f)>1?ba("createnewconference",{conference:{id:d,room:e,name:"",description:"",accessmode:"free",isselector:!1,record:!0,recordrights:"selected",everyonecaninvite:!0,canvieweachother:!0},competitors:f},function(a){1==a.result?c.conferenceId(d,!0):c.conferenceId(!1),t(b,$(a.result,a,2204))}):t(b,Y(2203))},inviteToConf:function(a,b,c){a||t(c,!1);var d=this;b=T(b);var e,f=[],g=d.getHoldInfo().abonent||{};j(b)&&n(b,function(a){"string"==typeof a&&""!==a&&(d.isAbonent(a,g)?e=a:f.push(s(a)?{userid:a}:{number:a}))});var h=function(){ba("invitetoconference",{conferenceid:a,competitors:f},function(a){t(c,$(a.result,a,2202))})};if(0!=l(f)||e)if(e){if(a!=d.conferenceId())return void t(c,Y(2206));ba("checkcanconnecttogathertoconference",{},function(a){a.canconnecttogather?(ba("connecttogathertoconference"),0!=l(f)?h():t(c,Z())):t(c,Y(2206))})}else 0!=l(f)?h():t(c,Y(2207));else t(c,Y(2201))},endCall:function(a){var b=this;a=T(a);var c=!1,d=!1;a&&n(a,function(a){!c&&b.isAbonent(a)&&(c=!0),d||a!=G.number&&a!=G.userid||(d=!0)}),a?b.getHoldInfo().hasHold&&(d||!b.conferenceId()&&c)?b.makeFlash("abort"):(c||d)&&(b.state()==b.states.TALK?b.conferenceId()?b.kickConfAbonent(b.conferenceId(),a):b.abortCall():b.state()==b.states.BACKCALL?b.abortAcmCall():b.state()==b.states.CALL?b.abortCall():(b.state()==b.states.RING||b.state()==b.states.BACKRING)&&b.declineCall()):b.state()==b.states.TALK||b.state()==b.states.CALL||b.getHoldInfo().hasHold?b.abortCall():b.state()==b.states.BACKCALL?b.abortAcmCall():(b.state()==b.states.RING||b.state()==b.states.BACKRING)&&b.declineCall()},abortCall:function(){ba("pbxabortcall")},declineCall:function(){ba("pbxdeclinecall")},kickConfAbonent:function(a,b){b=T(b);var c=this;ba("getconferencecompetitors",{conferenceid:a},function(d){for(var e={},f={},g=!1,h=0,i=d.competitorlist.length;i>h;h++)e[d.competitorlist[h].number]=d.competitorlist[h].competitorid,f[d.competitorlist[h].userid]=d.competitorlist[h].competitorid;var j;n(b,function(b){(j=e[b]||f[b]||"")&&(!b||b!=G.number&&b!=G.userid?ba("confdisconnectcompetitor",{conferenceid:a,competitor:{competitorid:j}}):g=!0)}),g&&c.exitConf(a)})},abortAcmCall:function(){ba("pbxautocallabort")},exitConf:function(a){ba("exitconference",{conferenceid:a})},makeTransfer:function(a,b){ba("pbxmaketransfer",{transferto:a?a+"":""}),t(b,Z())},transfer:function(a,b){var c=this;a||t(b,Y(2304)),c.state()==c.states.TALK?c.getHoldInfo().hasHold?!a||c.isAbonent(a,c.getHoldInfo().abonent||{})?(c.endCall(void 0),t(b,Z())):c.makeTransfer(a,b):a?c.makeTransfer(a,b):t(b,Y(2302)):t(b,Y(2303))},ghost:function(a,b,c){var d=this,e=function(a){d.loadConferenceInfo(t(c,a))};if(a=K[a]&&K[a].id||L[a]&&L[a].userid,!a)return t(e,Y(2504)),!1;if(b=b||"monitor",-1==["monitor","conference","help"].indexOf(b))return t(e,Y(2503)),!1;if(d.state()==d.states.READY)ba("attachasghost",{ghostedid:a},function(a){a.result?b&&"monitor"!=b?setTimeout(function(){d.conferenceId()&&d.changeGhostMode(b,e)},500):t(e,Z()):52710==a.error?t(e,Y(2505)):t(e,Y(2502))});else{var f=d.isAbonent(G.userid),g=d.conferenceId();if(!f||!g||!d.getConferenceInfo().isghost)return t(e,Y(2506)),!1;var h=d.isAbonent(a);if(!h)return t(e,Y(2507)),!1;h.isConferenceGhostMajor||"help"!=b&&"monitor"!=b?ba("confsetghostmode",{conferenceid:g,ghostmode:b},function(a){a.result,t(e,$(a.result,{},2502))}):ba("confsetvoiceparams",{conferenceid:g,competitor:{competitorid:h.guid,ghosthelp:"help"==b?!0:!1}},function(a){a.result,t(e,$(a.result,{},2502))})}},queue:function(a){var b=this;ba("getcurrentqueue",{},function(c){if(c.result){var d={},e=[],f=!1;j(c.queue)&&l(c.queue)>0&&n(c.queue,function(a){ab=b.createAbonent(a),d[ab.key]=ab,e.push(ab),b.queueList[ab.key]||b.isAbonent(ab.key)||(b.queueList[ab.key]=ab,B.trigger("queueAbonentEnter",ab),f=!0)}),n(b.queueList,function(a,c){d[c]||(B.trigger("queueAbonentLeave",a),delete b.queueList[c],f=!0)}),f&&B.trigger("queueChange",e),t(a,Z({queue:e}))}else t(a,Y(2701))})},startTalkTimer:function(a){var b=this;b.clearTalkTimer(!0),b._talkLength=Date.now()-1e3*(parseInt(a)||0),b.triggerTalkTimeEvent(),b._talkTimer=setInterval(function(){b.triggerTalkTimeEvent()},1e3)},triggerTalkTimeEvent:function(){var a=this;if(a._talkLength!==!1){var b=a.getCurrentTalkLength();B.trigger("talkTimer",b,a.formatTime(b))}else B.trigger("talkTimer",!1)},getCurrentTalkLength:function(){return Math.floor((Date.now()-this._talkLength)/1e3)},clearTalkTimer:function(a){clearInterval(this._talkTimer),this._talkLength=!1,a||this.triggerTalkTimeEvent()},formatTime:function(a){var b=a,c=Math.floor(b/3600),d=Math.floor(b/60)%60,e=b%60;return(c?c+":":"")+(10>d?"0"+d:d)+":"+(10>e?"0"+e:e)},talkLength:function(a){if(this._talkLength===!1)return"";var b=this.getCurrentTalkLength();return a?this.formatTime(b):b},dtmf:function(a){return this.sipActive&&"string"==typeof a&&a.match(/^[0-9\*#]{1}$/)?this.sip.dtmf(a):!1},hold:function(){this.sipActive?this.sip.hold():(this.state()==this.states.TALK||this.getHoldInfo().hasHold)&&this.makeFlash("switch")},resume:function(){this.getHoldInfo().hasHold&&this.sipActive&&this.sip.resume()},commutate:function(){this.state()===this.states.TALK&&this.getHoldInfo().hasHold&&this.sipActive&&this.endCall()}};i(ra,x),O("isAbonent",ra.isAbonent,ra),O("conferenceId",ra.conferenceId,ra),O("getHoldInfo",ra.getHoldInfo,ra),O("endCall",ra.endCall,ra),O("conference",ra.conference,ra),O("transfer",ra.transfer,ra),O("toggle",ra.toggleHold,ra),O("getState",ra.apiGetStateStr,ra),O("getQueue",ra.queue,ra),O("getTalkLength",ra.talkLength,ra),O("answer",ra.answer,ra),O("dtmf",ra.dtmf,ra),O("hold",ra.hold,ra),O("resume",ra.resume,ra),O("commutate",ra.commutate,ra);var sa={};sa["-"]={},sa[ra.states.DISCONNECTED]={},sa[ra.states.BACKCALL]={endCall:1},sa[ra.states.BACKRING]={endCall:1,answer:1},sa[ra.states.CALL]={endCall:1},sa[ra.states.READY]={conference:1,call:1,intercom:1,ghostListen:1,ghostHelp:1,ghostConference:1,transfer:1,toggle:1,endCall:1,resume:1},sa[ra.states.RING]={endCall:1,answer:1},sa[ra.states.TALK]={commutate:1,endCall:1,conference:1,call:1,resume:1,hold:1,intercom:1,toggle:1,transfer:1,ghostListen:1,ghostHelp:1,ghostConference:1};var ta={};ta["-"]={},ta[qa.states.DISCONNECTED]={},ta[qa.states.READY]={endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,ghostListen:1,ghostHelp:1,ghostConference:1,resume:1},ta[qa.states.BREAK]={endCall:1,call:1,intercom:1,toggle:1,transfer:1,ghostListen:1,resume:1,ghostHelp:1,ghostConference:1},ta[qa.states.OFF]={endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,ghostListen:1,ghostHelp:1,ghostConference:1},ta[qa.states.BUSY]={commutate:1,answer:1,endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,hold:1,ghostListen:1,ghostHelp:1,ghostConference:1},ta[qa.states.RESERVED]={},ta[qa.states.NOPHONE]={};var ua=function(){var a=[],b=ra.state();b="number"==typeof b?b:"-";var c=qa.state()||"-";c="number"==typeof c?c:"-",this.push=function(){n(arguments,function(d){sa[b][d]&&ta[c][d]&&a.push(d)})},this.getActions=function(){return a}},va=function(a){var b=new ua;if(!a||!R())return b.getActions();K[a]&&K[a].number&&!L[a]&&!M[a]&&(a=K[a].number);var c=G.userid==a||G.number==a,d=ra.isAbonent(a,ra.getHoldInfo().abonent||{}),e=K[a]||L[a]||M[a];e&&e.numberObj&&(e=e.numberObj);var f=ra.isAbonent(a)||e&&e.number&&ra.isAbonent(e.number),g=ra.isAbonent(a,ra.queueList)||e&&e.number&&ra.isAbonent(e.number,ra.queueList),h=ra.getHoldInfo().hasHold,i=ra.conferenceId()?!0:!1,j=(i&&f&&f.isConferenceCreator,i&&ra.isAbonent(G.userid)),k=i&&j&&j.isConferenceCreator,l=ra.state(),m=ra.intercomSupport;return g||(c?l!=ra.states.DISCONNECTED&&l!=ra.states.READY&&(l!=ra.states.RING&&l!=ra.states.BACKRING||!ra.sipActive&&m===!1||b.push("answer"),b.push("endCall")):(!e||e&&void 0!==e.state&&0!=e.state)&&(d?ra.sipActive&&ra.sip&&"function"==typeof ra.sip.isOnHold&&ra.sip.isOnHold()?(b.push("resume"),b.push("commutate")):b.push("toggle","commutate"):f?f&&(l!=ra.states.RING&&l!=ra.states.BACKRING||!ra.sipActive&&m===!1||b.push("answer"),i?k&&b.push("endCall"):(b.push("endCall"),ra.sipActive&&(h?h&&l==ra.states.TALK&&b.push("commutate"):b.push("hold")),e&&2==e.state||b.push("conference")),ra.getConferenceInfo().isghost&&ga(a)&&b.push("ghostListen","ghostHelp","ghostConference")):(i?(e&&2==e.state||b.push("conference"),b.push("transfer")):!h&&l==ra.states.TALK||l==ra.states.READY?(b.push("call"),l==ra.states.TALK&&b.push("transfer"),e&&2==e.state||b.push("conference"),b.push("intercom")):h&&l==ra.states.TALK&&b.push("transfer"),e&&5==e.state&&l==ra.states.READY&&ga(a)&&b.push("ghostListen","ghostHelp","ghostConference")))),b.getActions()};O("getPhoneActions",va),startQueueTimer=function(a){clearInterval(o),o=setInterval(function(){R()&&ra.queue()},a)};var wa=function(a){if(B.trigger("connecting"),R())return!0;a=a||{};var c=!1;i(E,a),b=E.debugMode,v=!1,E.oktellVoice&&(E.oktellVoice.isOktellVoice===!0?v=E.oktellVoice:window.oktellVoice&&window.oktellVoice.isOktellVoice===!0&&(v=window.oktellVoice));var k=u(J)||localStorage&&localStorage[J];void 0!==a.password&&null!==a.password?(E.password=e(g(a.password.toString().toLowerCase())),E.Password=e(g(a.password.toString())),k=null):(E.password=void 0,E.Password=void 0);var l=/^w[s]{1,2}:\/\/\S+$/,m=/:[0-9]{1,5}$/,n=function(a){if(l.test(a))return a;var b="https:"==location.protocol,c=b?":443":":80",d=b?"wss://":"ws://";return m.test(a)?d+a:d+a+c};if("string"==typeof E.url&&(E.url=[E.url]),!j(E.url))return t(E.callback,Y(1205)),B.trigger("connectError",Y(1205)),!1;for(var o=[],p=0,q=E.url.length;q>p;p++)"string"==typeof E.url[p]&&o.push(n(E.url[p]));E.url=o,G.url=E.url,G.login=E.login,G.defaultAvatar=E.defaultAvatar,G.defaultAvatar32x32=E.defaultAvatar32x32,G.defaultAvatar64x64=E.defaultAvatar64x64;if(!k&&(void 0===E.password||null===E.password))return t(E.callback,Y(1213)),B.trigger("connectError",Y(1213)),!1;var r=function(){f=new y(E.url,E.openTimeout,E.queryDelayMin,E.queryDelayMax,function(a){c=!1,G.currentUrl=f.url,ba("login",{Password:E.Password,password:E.password,sessionid:k||void 0,showid:1,usewebrtc:v?!0:!1,workplace:E.workplace||void 0,expires:E.expires||void 0},function(e){c=!0;var g=function(){return Y(i,"",{serverErrorMessage:e.errormsg,serverErrorCode:e.error})};if(e.error||e.errormsg){var i=1e3;50093==e.error?i=1204:50025==e.error?i=1214:"Service not available"==e.errormsg?i=1215:"Wrong login/pass combination"==e.errormsg?(u(J,null),localStorage&&delete localStorage[J],i=1202):("Bad request. Session does not exist"==e.errormsg||"Bad request. Invalid session user"==e.errormsg)&&(u(J,null),localStorage&&delete localStorage[J],i=1212),t(E.callback,g(i)),B.trigger("connectError",g(i)),xa(14,!1,!1)}else 1==e.result?(clearInterval(h),h=setInterval(function(){R()&&f.sendOktell("ping")},15e3),startQueueTimer(E.queueInterval),ra.queue(),da.sendCustomBinding(),f.bindOktellEvent("userstatechanged",function(a){qa.saveStatesFromServer(a)}),v&&setTimeout(function(){A=v.connect({login:e.sipuser,password:e.sippass,server:a.replace(/w[s]{1,2}:\/\//,"").replace("/","").split(":")[0]+":"+e.sipport,useWSS:e.sipsecure,debugMode:b}),A&&(A.on("connect",function(){F=!0,B.trigger("webphoneConnect")}),A.on("all",function(a){d("Oktell webphone event: "+a,arguments)}),A.on("disconnect",function(){F=!0,B.trigger("webphoneDisconnect")}),ra.setSipPhone(A))},200),G.userid=e.userid,G.sessionId=e.sessionid,G.sessionId&&(u(J,G.sessionId,{expires:E.expires}),localStorage&&(localStorage[J]=G.sessionId)),ba("getversion",{showalloweddbstoredprocs:1},function(a){a.result?(G.oktellDated=a.version.dated,G.oktellBuild=a.version.build,G.oktellDated<140918&&/2\.11\.[0-9]{4}\.[0-9]{5}/g.test(G.oktellBuild)&&(G.oktellBuild="2.11.1."+G.oktellDated),G.allowedProcedures=a.alloweddbstoredprocs||{},G.oktellWebServerPort=a.version.webserverport,G.oktellWebServerLink=ia(),U("pbxanswercall")||(ra.intercomSupport=!1),ba("getmyuserinfo",{},function(a){a.result?(G.number=a.mainpbxnumber,G.username=a.username,G.hasline=a.hasline,G.lineid=a.lineid,G.linenumber=a.linenumber,G.isoperator=a.isoperator,qa.loadBreakReasons(function(){qa.loadState(function(a){a?qa.checkUserRedirect(function(){ha(function(){f.bindOktellEvent("pbxnumberstatechanged",function(a){for(var b=0;b<a.numbers.length;b++){var c=L[a.numbers[b].num];c&&(c.state=a.numbers[b].numstateid)}}),fa(function(){ra.loadStates(function(a){if(a){c=!1,Q.trigger("login"),f.bindOktellEvent("httpresponsecopy",function(a){var b=a.response;if("200 OK"==b){var c=a.password,d=a.content;I[c]&&"function"==typeof I[c].callback&&I[c].callback(d)}}),t(E.callback,Z()),P(!0);for(var b=0;b<D.length;b++){var d=D[b];d&&d.eventName&&d.callback&&!d.binded&&(d.binded=!0,f.bindOktellEvent(d.eventName,d.callback))}B.trigger("connect")}else t(E.callback,g(1207)),B.trigger("connectError",g(1207)),xa(14)})})})}):(t(E.callback,g(1209)),B.trigger("connectError",g(1209)),xa(14))})})):(t(E.callback,g(1210)),B.trigger("connectError",g(1210)),xa(14))})):(t(E.callback,g(1206)),B.trigger("connectError",g(1206)),xa(11))})):(t(E.callback,g(1211)),B.trigger("connectError",g(1211)),xa(14))})}),f.on("errorConnection",function(){B.trigger("connectError",Y(1200)),t(E.callback,Y(1200))}),f.on("connectionClose",function(){N?(N=!1,xa(13)):c||xa(12)}),f.multiConnect(),b&&(G.server=f)};r()};O("connect",wa);var xa=function(a,b,c){c=arguments.length<3?"auto":c,P(!1);for(var d=0;d<D.length;d++){var e=D[d];e.binded=!1}return A&&A.disconnect&&A.disconnect(),R()?(("auto"===c||c)&&(u(J,null),localStorage&&delete localStorage[J]),N=!0,qa.state(0),ra.state(ra.states.DISCONNECTED),ba("logout")):("number"==typeof a&&(a=W(a)),b||B.trigger("disconnect",a)),!0},ya=function(){return u(J,null),!0};O("removeUserSession",ya),qa.on("userStateChange",function(a){setTimeout(function(){ra.loadStates()},400),5==a||(7==a?ra.state(ra.states.DISCONNECTED):ra.loadStates())}),Q.on("login",function(){f.bindOktellEvent("linestatechanged",function(){setTimeout(function(){ra.loadStates()},500)}),f.bindOktellEvent("flashstatechanged",function(){setTimeout(function(){ra.loadStates()},500)}),f.bindOktellEvent("confcompositionchanged",function(a){a.eventinfo.conferenceid==ra.conferenceId()&&(ra.setConfAbonentList(a.eventinfo.competitorlist),ra.loadStates())}),f.bindOktellEvent("confcompetitorstatechanged",function(a){a.eventinfo.conference.id==ra.conferenceId()&&ra.setConfAbonent(a.eventinfo.competitor)}),f.bindOktellEvent("phoneevent_acmcallstarted",function(){ra.loadStates(null,{isAutoCall:!0})}),f.bindOktellEvent("phoneevent_acmcallstopped",function(){setTimeout(function(){ra.loadStates()},700)}),f.bindOktellEvent("phoneevent_ringstarted",function(){ra.loadStates(function(){ra.conferenceId()&&ra.loadConferenceInfo()},!1)}),f.bindOktellEvent("phoneevent_ringstopped",function(){ra.loadStates()}),f.bindOktellEvent("phoneevent_ivrstarted",function(a){a.isroutingivr===!1?ra.notRoutingIvrState(!0):a.isroutingivr===!0&&ra.state()==ra.states.READY&&ra.loadStates()}),f.bindOktellEvent("phoneevent_commstarted",function(a){ra.startTalkTimer(0),ra.currentSessionData.commStarted=!0,a.isconference?(ra.buildConfFromCommCallback&&(ra.isConfCreator(!0),clearTimeout(ra.buildConfFromCommTimer)),ra.conferenceId(a.confid),ra.loadConferenceInfo(function(){ra.loadStates(function(){ra.buildConfFromCommCallback&&(t(ra.buildConfFromCommCallback,Z()),ra.buildConfFromCommCallback=void 0)})})):setTimeout(function(){ra.loadStates(function(){})},700)}),f.bindOktellEvent("phoneevent_commstopped",function(){ra.clearTalkTimer(),ra.currentSessionData.commStopped=!0,setTimeout(function(){ra.loadStates(function(){})},700)}),qa.loadBreakReasons()}),B.disconnect=function(a){return xa(13,a)},B.getAbonents=function(){return ra.getAbonents(!0)},B.call=function(a,b,c){ra.makeCall(a,!1,"string"==typeof b?b:"","function"==typeof b?b:c)},B.onNativeEvent=function(a,b){_(a,b)},B.offNativeEvent=function(a,b){aa(a,b)},B.getMyInfo=function(){return k(G)},B.intercom=function(a,b){ra.makeCall(a,!0,"",b)},B.ghostListen=function(a,b){ra.ghost(a,"monitor",b)},B.ghostHelp=function(a,b){ra.ghost(a,"help",b)},B.ghostConference=function(a,b){ra.ghost(a,"conference",b)},B.getUsers=function(){var a={};return n(K,function(b){a[b.id]=b}),a},B.getNumbers=function(){var a={};return n(L,function(b){a[b.number]=b}),a},B.getLunchReasons=B.getBreakReasons=function(){return k(qa.breakReasons)||{}},B.getLog=function(){return c},O("formatPhone",p,void 0),B.inCallCenter=function(){return qa.callCenterState()},B.webphoneIsActive=function(){return F},B.changePassword=function(a,b,c){"string"==typeof a&&a?(a=e(g(a)),b=e(g(b)),B.exec("changepassword",{newpwdmd5:a,oldpwdmd5:b},function(a){a.result?t(c,Z({result:!0})):"old password is wrong"==a.errormsg?t(c,Y(2801)):t(c,Y(2803))})):t(c,Y(2802))},B.config=function(a){return a?(void 0!==a.debugMode&&(b=Boolean(a.debugMode)),void 0!==a.queryDelayMin&&(f?f.setQueryDelayMin(a.queryDelayMin):E.queryDelayMin=a.queryDelayMin),void 0!==a.queryDelayMax&&(f?f.setQueryDelayMax(a.queryDelayMax):E.queryDelayMax=a.queryDelayMax),void 0!==a.queueInterval&&parseInt(a.queueInterval)&&startQueueTimer(parseInt(a.queueInterval)),void(void 0!==a.queryTimeout&&parseInt(a.queryTimeout)&&(E.queryTimeout=parseInt(a.queryTimeout)))):!1},B.version="1.7.2"};return i(A.prototype,x),A}(),window.oktell=new Oktell;